{{#section "styles"}}
<link rel="stylesheet" href="/static/signup.css" />
{{/section}}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("signupForm");
    const fullName = document.getElementById("fullName");
    const userName = document.getElementById("userName");
    const email = document.getElementById("email");
    const password = document.getElementById("password");
    const confirmPassword = document.getElementById("confirmPassword");
    const terms = document.getElementById("terms");

    //Helper functions 
    function showError(input, message) {
      let feedback = input.nextElementSibling;
      // Nếu chưa có div .invalid-feedback thì tạo mới
      if (!feedback || !feedback.classList.contains("invalid-feedback")) {
        feedback = document.createElement("div");
        feedback.className = "invalid-feedback";
        input.parentNode.appendChild(feedback);
      }
      feedback.textContent = message;
      input.classList.add("is-invalid");
    }

    function clearError(input) {
      const feedback = input.nextElementSibling;
      if (feedback && feedback.classList.contains("invalid-feedback")) {
        feedback.textContent = "";
      }
      input.classList.remove("is-invalid");
    }

    // Live Validation 
    fullName.addEventListener("input", () => {
      if (fullName.value.trim() === "") {
        showError(fullName, "Full name cannot be empty.");
      } else {
        clearError(fullName);
      }
    });

    email.addEventListener("input", () => {
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailPattern.test(email.value.trim())) {
        showError(email, "Please enter a valid email address.");
      } else {
        clearError(email);
      }
    });

    userName.addEventListener("blur", () => {
      const username = userName.value.trim();
      if (username === "") {
        showError(userName, "Username cannot be empty.");
        return;
      }

      // Gọi API kiểm tra username có tồn tại không
      fetch(`/account/is-available?u=${username}`)
        .then(res => res.json())
        .then(data => {
          if (data.available) {
            clearError(userName);
          } else {
            showError(userName, "This username is already taken. Please choose another.");
          }
        })
        .catch(() => {
          showError(userName, "Unable to check username availability. Try again later.");
        });
    });

    password.addEventListener("input", () => {
      if (password.value.length < 6) {
        showError(password, "Password must be at least 6 characters.");
      } else {
        clearError(password);
      }

      // 
      if (confirmPassword.value !== "") {
        if (confirmPassword.value !== password.value) {
          showError(confirmPassword, "Passwords do not match.");
        } else {
          clearError(confirmPassword);
        }
      }
    });

    confirmPassword.addEventListener("input", () => {
      if (confirmPassword.value !== password.value) {
        showError(confirmPassword, "Passwords do not match.");
      } else {
        clearError(confirmPassword);
      }
    });

    terms.addEventListener("change", () => {
      if (!terms.checked) {
        showError(terms, "You must agree to the Terms and Privacy Policy.");
      } else {
        clearError(terms);
      }
    });

    form.addEventListener("submit", function (event) {
      event.preventDefault();

      let isValid = true;

      // Full name
      if (fullName.value.trim() === "") {
        showError(fullName, "Full name cannot be empty.");
        isValid = false;
      }

      // Email
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailPattern.test(email.value.trim())) {
        showError(email, "Please enter a valid email address.");
        isValid = false;
      }

      // Password
      if (password.value.length < 6) {
        showError(password, "Password must be at least 6 characters.");
        isValid = false;
      }

      // Confirm password
      if (confirmPassword.value !== password.value || confirmPassword.value === "") {
        showError(confirmPassword, "Passwords do not match.");
        isValid = false;
      }

      // Terms
      if (!terms.checked) {
        showError(terms, "You must agree to the Terms and Privacy Policy.");
        isValid = false;
      }

      // Nếu có lỗi => hiện SweetAlert
      if (!isValid) {
        Swal.fire({
          icon: "error",
          title: "Form validation error",
          text: "Please fix the highlighted fields and try again.",
        });
        return;
      }

      Swal.fire({
        title: "Register account confirmation?",
        text: "Do you want to create this account?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Yes, create it!",
        cancelButtonText: "Cancel",
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit();
          Swal.fire({
            icon: "success",
            title: "Account created!",
            text: "Your account has been successfully registered.",
          });
        }
      });
    });
  });
</script>

<div class="auth-page container py-5 min-vh-100 d-flex align-items-center">
  <div class="row w-100 justify-content-center">
    <div class="col-12 col-md-10 col-lg-8 col-xxl-7">
      <div class="auth-card shadow-sm rounded-4 overflow-hidden bg-white">
        <div class="row g-0">
          <div class="col-lg-6 d-none d-lg-block auth-visual">
            <div class="auth-visual-inner h-100 w-100"></div>
          </div>
          <div class="col-12 col-lg-6 p-4 p-md-5">
            <div class="auth-header d-flex align-items-center gap-3 mb-4">
              <div>
                <div class="small text-muted">Join Online Academy</div>
                <h1 class="h4 mb-0">Create your account</h1>
              </div>
            </div>
            <form method="post" action="/account/signup" novalidate id="signupForm">
              <div class="mb-3"> <label for="fullName" class="form-label">Full
                  name</label> <input type="text" class="form-control form-control-lg" id="fullName" name="fullName"
                  placeholder="Nguyen Van A" required /> </div>
              <div class="mb-3"> <label for="userName" class="form-label">User
                  name</label> <input type="text" class="form-control form-control-lg" id="userName" name="userName"
                  placeholder="nguyenvana01" required /> </div>
              <div class="mb-3"> <label for="email" class="form-label">Email</label> <input type="email"
                  class="form-control form-control-lg" id="email" name="email" placeholder="you@example.com" required />
              </div>
              <div class="mb-3"> <label for="password" class="form-label">Password</label> <input type="password"
                  class="form-control form-control-lg" id="password" name="password" placeholder="Xxx@123" required />
              </div>
              <div class="mb-3"> <label for="confirmPassword" class="form-label">Confirm password</label> <input
                  type="password" class="form-control form-control-lg" id="confirmPassword" name="confirmPassword"
                  placeholder="Xxx@123" required /> </div>
              <div class="form-check mb-4"> <input class="form-check-input" type="checkbox" value="1" id="terms"
                  required /> <label class="form-check-label" for="terms"> I
                  agree to the <a href="#" class="text-decoration-none">Terms</a> and <a href="#"
                    class="text-decoration-none">Privacy
                    Policy</a>. </label> </div> <button type="submit"
                class="btn btn-dark btn-lg w-100 rounded-pill">Create
                Account</button>
              <p class="text-center text-muted mt-4 mb-0"> Already have an
                account? <a href="/account/signin" class="text-decoration-none">Sign in</a> </p>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>